"""Observation functions for traffic signals."""
from abc import abstractmethod

import numpy as np
from gymnasium import spaces

from .traffic_signal import TrafficSignal
import traci


class ObservationFunction:
    """Abstract base class for observation functions."""

    def __init__(self, ts: TrafficSignal):
        """Initialize observation function."""
        self.ts = ts
        self.position_dict = {
            "1863241632": (211853.30, 452381.40),
            "2330725114": (211732.52, 452679.34),
            "243351999": (212742.35, 451716.32),
            "243641585": (212838.42, 452444.09),
            "243749571": (212210.39, 452950.62),
            "30503246": (213383.68, 452432.44),
            "30624898": (213384.79, 452460.64),
            "32564122": (213219.70, 451881.92),
            "89127267": (213241.00, 452982.76),
            "89173763": (211755.99, 451798.61),
            "89173808": (211776.01, 451176.78),
            "cluster_1427494838_273472399": (213033.16, 453362.24),
            "cluster_1757124350_1757124352": (213066.85, 451176.69),
            "cluster_1863241547_1863241548_1976170214": (211890.89, 452219.56),
            "cluster_306484187_cluster_1200363791_1200363826_1200363834_1200363898_1200363927_1200363938_1200363947_1200364074_1200364103_1507566554_1507566556_255882157_306484190": (
                213022.31,
                451590.51,
            ),
            "gneJ143": (213032.38, 451298.49),
            "gneJ207": (212995.95, 451459.29),
            "gneJ208": (211970.05, 452780.92),
            "gneJ210": (213588.24, 452104.21),
            "gneJ255": (213402.37, 452063.43),
            "gneJ257": (212851.24, 452418.74),
        }
        self.light_in = {
            "1863241632": [
                "224892361#7_1",
                "224892361#7_2",
                "170018165#0_1",
                "170018165#0_2",
                "-170018165#1_1",
                "-170018165#1_2",
                "-170018165#1_3",
            ],
            "2330725114": [
                "224251776#0_1",
                "224251776#0_2",
                "170018165#2.175_1",
                "170018165#2.175_2",
                "-306240162#1_0",
                "-306240162#1_1",
            ],
            "243351999": [
                "-233675413#6_1",
                "-233675413#6_1",
                "233675413#3_1",
                "233675413#3_2",
                "-22690205#1_1",
                "-22690205#1_1",
            ],
            "243641585": [
                "23166741#5_1",
                "23166741#5_1",
                "23166741#5_2",
                "23166741#5_2",
                "174800513_1",
                "174800513_2",
                "-201201945#0.78_1",
                "-201201945#0.78_1",
                "-201201945#0.78_1",
                "-201201945#0.78_2",
            ],
            "243749571": [
                "315358254#0_1",
                "315358254#0_1",
                "315358254#0_2",
                "315358257#0.43_1",
                "315358257#0.43_1",
                "315358257#0.43_2",
                "315358255#0_1",
                "315358255#0_1",
                "315358255#0_2",
                "612075153#1_1",
                "612075153#1_1",
                "612075153#1_2",
            ],
            "30503246": [
                "136436466_1",
                "136436466_2",
                "136436466_3",
                "136436466_3",
                "-4942389#0_1",
                "-4942389#0_1",
                "-4942389#0_1",
                "-4942389#0_2",
                "-4942389#0_3",
                "202092676#0_1",
                "202092676#0_2",
                "202092676#0_2",
                "202092676#0_2",
                "202092676#0_2",
            ],
            "30624898": [
                "315358251#1_1",
                "315358251#1_1",
                "315358251#1_2",
                "315358251#1_2",
                "315358251#1_3",
                "386687232#0_1",
                "386687232#0_1",
                "386687232#0_2",
                "386687232#0_2",
                "386687232#0_2",
                "386687232#0_2",
                "-136436466_1",
                "-136436466_2",
                "-136436466_3",
                "-136436466_3",
            ],
            "32564122": [
                "32999434#0_1",
                "32999434#0_1",
                "32999434#0_2",
                "-201089423#1_1",
                "-201089423#1_2",
                "-201089423#1_2",
                "-24693977#0_1",
                "-24693977#0_2",
                "-24693977#0_3",
            ],
            "89127267": [
                "-447569997#0_1",
                "-447569997#0_1",
                "-447569997#0_2",
                "-447569997#0_2",
                "-129379918#1_1",
                "-129379918#1_1",
                "-129379918#1_2",
                "315358252#0_1",
                "315358252#0_2",
                "315358252#0_3",
                "315358252#0_3",
            ],
            "89173763": [
                "-10427692#1_1",
                "-10427692#1_1",
                "-10427692#1_2",
                "-201963533#0_1",
                "-201963533#0_2",
                "-201963533#0_3",
                "-18809672#1_1",
                "-18809672#1_1",
                "-18809672#1_1",
                "285549250#0_1",
                "285549250#0_1",
                "285549250#0_2",
            ],
            "89173808": [
                "-18813598#1_1",
                "-18813598#1_1",
                "-18813598#1_2",
                "-25122731#1_1",
                "-25122731#1_1",
                "-25122731#1_1",
                "-18809673#1.275_1",
                "-18809673#1.275_1",
                "-18809673#1.275_2",
                "201963522#6_1",
                "201963522#6_1",
                "201963522#6_1",
            ],
            "cluster_1427494838_273472399": [
                "-129379921#0_1",
                "-129379921#0_2",
                "-129379921#0_3",
                "129379967#0_1",
                "129379967#0_2",
                "315358250#1_1",
                "315358250#1_1",
                "315358250#1_2",
            ],
            "cluster_1757124350_1757124352": [
                "124812856#1_1",
                "124812856#1_2",
                "124812856#1_3",
                "-173169611#0_1",
                "-173169611#0_1",
                "201956819#0_1",
                "201956819#0_1",
                "201956819#0_2",
            ],
            "cluster_1863241547_1863241548_1976170214": [
                "176550246_1",
                "176550246_2",
                "176550246_3",
                "176550246_4",
                "201238726#1_1",
                "201238726#1_1",
                "201238726#1_2",
                "201238726#1_3",
                "128361109#4_1",
                "128361109#4_2",
                "128361109#4_3",
                "128361109#4_4",
                "137133006#1_1",
                "137133006#1_2",
                "137133006#1_3",
            ],
            "cluster_306484187_cluster_1200363791_1200363826_1200363834_1200363898_1200363927_1200363938_1200363947_1200364074_1200364103_1507566554_1507566556_255882157_306484190": [
                "285716192#0.83_1",
                "285716192#0.83_2",
                "285716192#0.83_3",
                "285716192#0.83_4",
                "104012170_1",
                "104012170_2",
                "104012170_3",
                "104012170_4",
                "27920078#1_1",
                "27920078#1_2",
                "27920078#1_3",
                "27920078#1_4",
            ],
            "gneJ143": [
                "10425609#1_1",
                "10425609#1_2",
                "10425609#1_3",
                "201956821#1.68_1",
                "201956821#1.68_1",
                "201956821#1.68_2",
                "201956821#1.68_3",
                "201956821#1.68_3",
                "124812857#0_1",
                "124812857#0_1",
                "124812857#0_2",
                "124812857#0_3",
            ],
            "gneJ207": [
                "201963537#1_1",
                "201963537#1_2",
                "201963537#1_3",
                "164051413_1",
                "164051413_2",
                "104010354_1",
                "104010354_1",
                "104010354_2",
            ],
            "gneJ208": [
                "-286646456#2_1",
                "-286646456#2_2",
                "-224892361#1_1",
                "-224892361#1_2",
                "286646456#0_1",
                "286646456#0_1",
            ],
            "gneJ210": [
                "32124637#1_1",
                "32124637#1_2",
                "32124637#1_3",
                "32124637#1_3",
                "32021112#0_1",
                "32021112#0_1",
                "32021112#0_2",
                "32021112#0_2",
                "32021112#0_3",
                "32021112#0_3",
                "51857517#1_1",
                "51857517#1_2",
                "51857517#1_3",
                "51857517#1_4",
            ],
            "gneJ255": [
                "168702040#4_1",
                "168702040#4_2",
                "168702040#4_3",
                "32999110#0_1",
                "32999110#0_2",
                "32999110#0_3",
                "315358253#2_1",
                "315358253#2_2",
                "315358253#2_2",
            ],
            "gneJ257": [
                "201238718#1_1",
                "201238718#1_1",
                "176550249#4_1",
                "176550249#4_1",
                "176550249#4_2",
                "176550249#4_2",
                "-174800513_1",
                "-174800513_2",
            ],
        }
        self.light_out = {
            "1863241632": [
                "170018165#1_1",
                "-170018165#0_2",
                "-224892361#8_1",
                "170018165#1_1",
                "-170018165#0_1",
                "-170018165#0_2",
                "-224892361#8_1",
            ],
            "2330725114": [
                "306240162#0_0",
                "-170018165#3_1",
                "-224251776#1_1",
                "306240162#0_0",
                "-170018165#3_1",
                "-224251776#1_1",
            ],
            "243351999": [
                "22690205#0_1",
                "-233675413#3_1",
                "233675413#4_1",
                "22690205#0_1",
                "-233675413#3_1",
                "233675413#4_1",
            ],
            "243641585": [
                "201201945#0_1",
                "201201953#0_1",
                "201201953#0_2",
                "-174800513_2",
                "201201945#0_1",
                "201201953#0_2",
                "201201953#0_1",
                "201201953#0_2",
                "-174800513_1",
                "-174800513_2",
            ],
            "243749571": [
                "-612075153#1_1",
                "-315358255#4_1",
                "-315358257#2_1",
                "-315358254#1_1",
                "-612075153#1_1",
                "-315358255#4_1",
                "-315358257#2_1",
                "-315358254#1_1",
                "-612075153#1_1",
                "-315358255#4_1",
                "-315358257#2_1",
                "-315358254#1_1",
            ],
            "30503246": [
                "4942389#0_1",
                "4942389#0_2",
                "386687235_1",
                "386687235_2",
                "386687235_1",
                "386687235_2",
                "-136436466_1",
                "-136436466_2",
                "-136436466_3",
                "386687235_1",
                "386687235_2",
                "-136436466_1",
                "-136436466_2",
                "-136436466_3",
            ],
            "30624898": [
                "386687242_1",
                "386687242_2",
                "136436466_1",
                "136436466_2",
                "136436466_3",
                "-315358251#1_1",
                "-315358251#1_2",
                "386687242_1",
                "386687242_2",
                "136436466_2",
                "136436466_3",
                "-315358251#1_1",
                "-315358251#1_2",
                "386687242_1",
                "386687242_2",
            ],
            "32564122": [
                "24693977#0_1",
                "201089423#0_1",
                "201089423#0_2",
                "-32999434#1_1",
                "-32999434#1_2",
                "24693977#0_1",
                "201089423#0_1",
                "201089423#0_2",
                "-32999434#1_2",
            ],
            "89127267": [
                "-315358252#1_1",
                "-315358252#1_2",
                "129379918#0_1",
                "129379918#0_2",
                "447569997#0_1",
                "-315358252#1_1",
                "-315358252#1_2",
                "129379918#0_1",
                "129379918#0_2",
                "447569997#0_1",
                "447569997#0_2",
            ],
            "89173763": [
                "-285549250#1_1",
                "18809672#0_1",
                "201963533#0_1",
                "10427692#0_1",
                "-285549250#1_1",
                "18809672#0_1",
                "201963533#0_1",
                "10427692#0_1",
                "-285549250#1_1",
                "18809672#0_1",
                "201963533#0_1",
                "10427692#0_1",
            ],
            "89173808": [
                "-201963522#9_1",
                "18809673#0_1",
                "25122731#0_1",
                "18813598#0_1",
                "-201963522#9_1",
                "18809673#0_1",
                "25122731#0_1",
                "18813598#0_1",
                "-201963522#9_1",
                "18809673#0_1",
                "25122731#0_1",
                "18813598#0_1",
            ],
            "cluster_1427494838_273472399": [
                "-315358250#1_1",
                "-315358250#1_2",
                "129379968_1",
                "129379921#0_1",
                "-315358250#1_2",
                "129379968_1",
                "129379921#0_1",
                "129379921#0_2",
            ],
            "cluster_1757124350_1757124352": [
                "201956821#0_1",
                "201956821#0_2",
                "201956810_1",
                "201956820_1",
                "201956821#0_2",
                "201956810_1",
                "201956820_1",
                "201956820_2",
            ],
            "cluster_1863241547_1863241548_1976170214": [
                "201238719#0_1",
                "201238729#1_1",
                "201238729#1_2",
                "-201238726#1_1",
                "201238730_1",
                "201238719#0_1",
                "201238719#0_2",
                "201238729#1_2",
                "-201238726#1_1",
                "201238730_1",
                "201238730_2",
                "201238719#0_2",
                "201238729#1_1",
                "-201238726#1_1",
                "201238730_2",
            ],
            "cluster_306484187_cluster_1200363791_1200363826_1200363834_1200363898_1200363927_1200363938_1200363947_1200364074_1200364103_1507566554_1507566556_255882157_306484190": [
                "104010439#1_1",
                "104010439#1_2",
                "201963535_1",
                "201963535_2",
                "-32124745_1",
                "-32124745_2",
                "104010460#1_1",
                "104010460#1_2",
                "201963535_1",
                "201963535_2",
                "-32124745_1",
                "-32124745_2",
            ],
            "gneJ143": [
                "201963537#1_1",
                "25149219#1_1",
                "201956819#0_2",
                "201956811#0_1",
                "201963537#1_1",
                "201963537#1_2",
                "201963537#1_3",
                "25149219#1_1",
                "25149219#1_1",
                "201956819#0_1",
                "201956819#0_2",
                "201956811#0_1",
            ],
            "gneJ207": [
                "104010475#0_1",
                "104010475#0_2",
                "-164051413_1",
                "124812857#0_1",
                "104010475#0_2",
                "-164051413_1",
                "124812857#0_2",
                "124812857#0_3",
            ],
            "gneJ208": [
                "-286646456#0_1",
                "224892361#1_1",
                "286646456#1_1",
                "-286646456#0_1",
                "224892361#1_1",
                "286646456#1_1",
            ],
            "gneJ210": [
                "168702040#1_1",
                "168702040#1_2",
                "51857518#1_1",
                "51857518#1_2",
                "51857516#1_1",
                "51857516#1_2",
                "168702040#1_1",
                "168702040#1_2",
                "168702040#1_1",
                "168702040#1_2",
                "51857518#1_1",
                "51857518#1_2",
                "51857516#1_1",
                "51857516#1_2",
            ],
            "gneJ255": [
                "-315358253#2_1",
                "168702039#1_1",
                "168702039#1_2",
                "402600768#0_1",
                "402600768#0_2",
                "-315358253#2_1",
                "168702039#1_1",
                "168702039#1_2",
                "402600768#0_2",
            ],
            "gneJ257": [
                "201201950#0_1",
                "174800513_1",
                "-201238718#1_1",
                "201201950#0_1",
                "201201950#0_2",
                "174800513_2",
                "-201238718#1_1",
                "201201950#0_2",
            ],
        }
        self.neibors = {
            "1863241632": ["cluster_1863241547_1863241548_1976170214", "2330725114", "gneJ208", "89173763"],
            "2330725114": ["gneJ208", "1863241632", "cluster_1863241547_1863241548_1976170214", "243749571"],
            "243351999": [
                "cluster_306484187_cluster_1200363791_1200363826_1200363834_1200363898_1200363927_1200363938_1200363947_1200364074_1200364103_1507566554_1507566556_255882157_306484190",
                "gneJ207",
                "32564122",
                "gneJ143",
            ],
            "243641585": ["gneJ257", "30503246", "30624898", "89127267"],
            "243749571": ["gneJ208", "2330725114", "1863241632", "cluster_1863241547_1863241548_1976170214"],
            "30503246": ["30624898", "gneJ255", "gneJ210", "gneJ257"],
            "30624898": ["30503246", "gneJ255", "gneJ210", "gneJ257"],
            "32564122": [
                "gneJ255",
                "cluster_306484187_cluster_1200363791_1200363826_1200363834_1200363898_1200363927_1200363938_1200363947_1200364074_1200364103_1507566554_1507566556_255882157_306484190",
                "gneJ210",
                "gneJ207",
            ],
            "89127267": ["cluster_1427494838_273472399", "30624898", "30503246", "243641585"],
            "89173763": ["cluster_1863241547_1863241548_1976170214", "1863241632", "89173808", "2330725114"],
            "89173808": ["89173763", "cluster_1863241547_1863241548_1976170214", "243351999", "1863241632"],
            "cluster_1427494838_273472399": ["89127267", "243749571", "243641585", "gneJ257"],
            "cluster_1757124350_1757124352": [
                "gneJ143",
                "gneJ207",
                "cluster_306484187_cluster_1200363791_1200363826_1200363834_1200363898_1200363927_1200363938_1200363947_1200364074_1200364103_1507566554_1507566556_255882157_306484190",
                "243351999",
            ],
            "cluster_1863241547_1863241548_1976170214": ["1863241632", "89173763", "2330725114", "gneJ208"],
            "cluster_306484187_cluster_1200363791_1200363826_1200363834_1200363898_1200363927_1200363938_1200363947_1200364074_1200364103_1507566554_1507566556_255882157_306484190": [
                "gneJ207",
                "gneJ143",
                "243351999",
                "32564122",
            ],
            "gneJ143": [
                "cluster_1757124350_1757124352",
                "gneJ207",
                "cluster_306484187_cluster_1200363791_1200363826_1200363834_1200363898_1200363927_1200363938_1200363947_1200364074_1200364103_1507566554_1507566556_255882157_306484190",
                "243351999",
            ],
            "gneJ207": [
                "cluster_306484187_cluster_1200363791_1200363826_1200363834_1200363898_1200363927_1200363938_1200363947_1200364074_1200364103_1507566554_1507566556_255882157_306484190",
                "gneJ143",
                "cluster_1757124350_1757124352",
                "243351999",
            ],
            "gneJ208": ["2330725114", "243749571", "1863241632", "cluster_1863241547_1863241548_1976170214"],
            "gneJ210": ["gneJ255", "30503246", "30624898", "32564122"],
            "gneJ255": ["gneJ210", "32564122", "30503246", "30624898"],
            "gneJ257": ["243641585", "30503246", "30624898", "32564122"],
        }
        self.weighted_distance = {
            "1863241632": [2.1968185389124053, 1.5367305838354894, 1.2784619419412826, 0.9281220773644843],
            "2330725114": [1.8332030345352341, 1.614507837798352, 1.2006686777218378, 1.0784627743469977],
            "243351999": [1.7010559196305808, 1.5385799829825912, 1.202603578720078, 1.1959633599114556],
            "243641585": [4.144941915728891, 1.190097253164307, 1.1878332394713438, 0.980608447001179],
            "243749571": [2.062211637062625, 1.4375036789630058, 1.2363236508452646, 1.064623695194556],
            "30503246": [3.8430737045377996, 1.271064990934647, 1.2253773461367903, 0.9053686172810708],
            "30624898": [3.8835065002400317, 1.2381589839420415, 1.2064521857483628, 0.9409757053228165],
            "32564122": [1.7741213215325544, 1.4616562432342024, 1.2605119161945104, 1.155161200061315],
            "89127267": [1.633137050007206, 1.4086604304701202, 1.3600819597150335, 1.192130493781823],
            "89173763": [1.746984809690918, 1.4568028511461002, 1.4051941748995582, 1.0572728681926082],
            "89173808": [1.8571323107484663, 1.3346396918171812, 1.281125474006193, 1.1943434989813406],
            "cluster_1427494838_273472399": [2.0170868306376106, 1.262697285919107, 1.2426972242604692, 1.2192122478768008],
            "cluster_1757124350_1757124352": [2.4479115678941246, 1.6142616792998499, 1.2576248807246577, 0.8435982841347631],
            "cluster_1863241547_1863241548_1976170214": [
                2.3025302664846237,
                1.3240157634815204,
                1.228603151331194,
                1.0752024549541888,
            ],
            "cluster_306484187_cluster_1200363791_1200363826_1200363834_1200363898_1200363927_1200363938_1200363947_1200364074_1200364103_1507566554_1507566556_255882157_306484190": [
                2.0926186159583944,
                1.311858114488407,
                1.2626563349787798,
                1.1257298136002787,
            ],
            "gneJ143": [2.155116607012449, 1.8908320100195903, 1.3186034647093474, 0.764309125480595],
            "gneJ207": [1.9610186639213925, 1.752486707761648, 1.1831214161602315, 0.9685804462937885],
            "gneJ208": [1.782466130909063, 1.6524338288204454, 1.3055022922779735, 0.9965310777186618],
            "gneJ210": [2.0083372587530994, 1.2990993380918678, 1.239741382001208, 1.1922026079305226],
            "gneJ255": [1.8538529386892486, 1.5513276932047158, 1.1903026628258737, 1.1169638601310359],
            "gneJ257": [4.119193213476605, 1.1880383584442749, 1.1832126507837886, 0.9871676765541152],
        }

    def lanes_density(self, the_lane: list) -> list:
        """计算车道密度"""
        lanes_density = [
            traci.lane.getLastStepVehicleNumber(lane)
            / (traci.lane.getLength(lane) / (2.5 + traci.lane.getLastStepLength(lane)))
            for lane in the_lane
        ]
        return [min(1, density) for density in lanes_density]

    def get_news(self) -> list:
        """返回所有智能体补充状态"""
        add_state = []
        count = 0
        for neibor in self.neibors[self.ts.id]:
            lanes_in = self.light_in[neibor]  # 获得指定路口的进车道列表
            lanes_out = self.light_out[neibor]  # 获得指定路口的出车道列表
            add_state.append(
                sum(self.lanes_density(lanes_in)) / len(self.lanes_density(lanes_in)) * self.weighted_distance[neibor][count]
            )
            add_state.append(
                sum(self.lanes_density(lanes_out)) / len(self.lanes_density(lanes_out)) * self.weighted_distance[neibor][count]
            )
            count += 1
        return add_state

    @abstractmethod
    def __call__(self):
        """Subclasses must override this method."""
        phase_id = [1 if self.ts.green_phase == i else 0 for i in range(self.ts.num_green_phases)]  # one-hot encoding
        min_green = [0 if self.ts.time_since_last_phase_change < self.ts.min_green + self.ts.yellow_time else 1]
        density = self.ts.get_lanes_density()
        queue = self.ts.get_lanes_queue()
        observation = np.array(phase_id + min_green + density + queue + self.get_news(), dtype=np.float32)
        return observation

    @abstractmethod
    def observation_space(self):
        """Subclasses must override this method."""
        return spaces.Box(
            low=np.zeros(self.ts.num_green_phases + 1 + 2 * len(self.ts.lanes) + 8, dtype=np.float32),
            high=np.ones(self.ts.num_green_phases + 1 + 2 * len(self.ts.lanes) + 8, dtype=np.float32),
        )


class DefaultObservationFunction(ObservationFunction):
    """Default observation function for traffic signals."""

    def __init__(self, ts: TrafficSignal):
        """Initialize default observation function."""
        super().__init__(ts)

    def __call__(self) -> np.ndarray:
        """Return the default observation."""
        phase_id = [1 if self.ts.green_phase == i else 0 for i in range(self.ts.num_green_phases)]  # one-hot encoding
        min_green = [0 if self.ts.time_since_last_phase_change < self.ts.min_green + self.ts.yellow_time else 1]
        density = self.ts.get_lanes_density()
        queue = self.ts.get_lanes_queue()
        observation = np.array(phase_id + min_green + density + queue, dtype=np.float32)
        return observation

    def observation_space(self) -> spaces.Box:
        """Return the observation space."""
        return spaces.Box(
            low=np.zeros(self.ts.num_green_phases + 1 + 2 * len(self.ts.lanes), dtype=np.float32),
            high=np.ones(self.ts.num_green_phases + 1 + 2 * len(self.ts.lanes), dtype=np.float32),
        )
